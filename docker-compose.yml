version: '3.8'

services:
  # 1. Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qna_qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped

  # 2. Mock Email Server
  mailpit:
    image: axllent/mailpit:latest
    container_name: qna_mailpit
    ports:
      - "1025:1025" # SMTP Port
      - "8025:8025" # Web UI Port
    restart: unless-stopped

  # 3. AI Service (Python)
  ai-svc:
    build:
      context: ./ai-service
    container_name: qna_ai_service
    environment:
      - EMBED_MODEL=intfloat/e5-small-v2
      - LLM_BASE_MODEL=Qwen/Qwen2.5-0.5B-Instruct
      - DEVICE=cpu
      # QUAN TRỌNG: Chỉ định thư mục cache khớp với volume bên dưới
      - HF_HOME=/hf-cache 
    ports:
      - "8000:8000"
    volumes:
      # Mount volume vào đường dẫn /hf-cache
      - hf_cache:/hf-cache
    restart: unless-stopped

  # 4. Backend API (.NET)
  webapi:
    build:
      context: ./backend
      dockerfile: WebApi/Dockerfile
    container_name: qna_webapi
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      
      # Kết nối đến AI Service (dùng tên service 'ai-svc')
      - AIService__BaseUrl=http://ai-svc:8000
      
      # Kết nối đến Qdrant (dùng tên service 'qdrant')
      - Qdrant__BaseUrl=http://qdrant:6333
      - Qdrant__Collection=kb
      - Qdrant__VectorName=dense_v1
      - Qdrant__TopK=8
      
      # Kết nối đến Mailpit (dùng tên service 'mailpit')
      - Email__Smtp__Host=mailpit
      - Email__Smtp__Port=1025
      - Email__Smtp__UseSsl=false
      - Email__Smtp__User=
      - Email__Smtp__Pass=
      - Email__From=no-reply@qna.local
    ports:
      - "8080:8080"
    depends_on:
      - qdrant
      - ai-svc
      - mailpit
    restart: unless-stopped
    
  fe-test:
    build:
      context: ./fe-test
    ports:
      - "8090:80"
    depends_on:
      - webapi
      - ai-svc

volumes:
  qdrant_data:
  hf_cache: